<!DOCTYPE html>
<html class="dark" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Team Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    .highlight {
      background-color: yellow !important;
    }

    .question-display {
      position: fixed;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      background-color: #000000;
      color: #FFFFFF;
      padding: 20px;
      border-radius: 10px;
      width: 400px;
      height: 400px;
      text-align: left;
      font-size: 16px;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .question-display h3 {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #FFFF00;
    }

    .grid-item {
      position: relative;
    }

    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #09f;
      animation: spin 1s ease infinite;
    }

    .body {
      -webkit-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <script>
    document.addEventListener('contextmenu', event => event.preventDefault());
    document.addEventListener('selectstart', event => event.preventDefault());
    document.addEventListener('copy', event => event.preventDefault());
    document.addEventListener('cut', event => event.preventDefault());
    document.addEventListener('paste', event => event.preventDefault());

    const LOGIN_END_TIME = new Date('2024-09-30T11:50:00');

    let attemptedQuestions = [];

    window.onload = function() {
      if (localStorage.getItem('teamID')) {
        showDashboard();
      } else {
        document.getElementById('loginForm').style.display = 'block';
      }
      startCountdownTimer();
    };

    function startCountdownTimer() {
      const countdownElement = document.getElementById('countdownTimer');
      const interval = setInterval(function() {
        const now = new Date();
        const timeLeft = LOGIN_END_TIME - now;

        if (timeLeft <= 0) {
          clearInterval(interval);
          countdownElement.textContent = 'Login time has ended.';
        } else {
          const hours = Math.floor(timeLeft / (1000 * 60 * 60));
          const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
          countdownElement.textContent = `${hours}h ${minutes}m ${seconds}s left`;
        }
      }, 1000);
    }

   function login() {
    const teamID = document.getElementById('teamID').value;
    const contactNumber = document.getElementById('contactNumber').value;

    document.getElementById('loginButton').innerHTML = '<div class="spinner mx-auto"></div>';
    document.getElementById('loginButton').disabled = true;

    google.script.run.withSuccessHandler(function(response) {
      document.getElementById('loginButton').innerHTML = 'Login';
      document.getElementById('loginButton').disabled = false;

      if (response.success) {
        localStorage.setItem('teamID', response.teamID);
        localStorage.setItem('teamName', response.teamName);
        localStorage.setItem('teamLeader', response.teamLeader);
        localStorage.setItem('email', response.email);  // Store email
        showDashboard();
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Login Failed',
          text: response.message || 'Check your credentials!',
        });
      }
    }).doLogin(teamID, contactNumber);
  }

    function showDashboard() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';

      document.getElementById('teamIDDisplay').textContent = localStorage.getItem('teamID');
      document.getElementById('teamNameDisplay').textContent = localStorage.getItem('teamName');
      document.getElementById('teamLeaderDisplay').textContent = localStorage.getItem('teamLeader');

      google.script.run.withSuccessHandler(function(questions) {
        const grid = document.getElementById('questionGrid');
        grid.innerHTML = ''; // Clear the grid

        for (let i = 0; i < questions.length; i++) {
          const gridItem = document.createElement('div');
          gridItem.classList.add('grid-item', 'bg-gray-300', 'p-4', 'text-center', 'rounded', 'hover:bg-blue-300', 'transition');
          gridItem.style.backgroundColor = questions[i].attemptedBy ? 'green' : '';

          gridItem.innerHTML = `<div>${i + 1}</div>`;

          gridItem.onmouseover = function() {
            highlightCombinations(i + 1);
            showQuestion(questions[i].question);
          };

          gridItem.onmouseout = function() {
            removeHighlight();
            hideQuestion();
          };

          gridItem.onclick = function() {
            showOptions(i + 1);
          };

          grid.appendChild(gridItem);
        }
      }).getQuestions(localStorage.getItem('teamID'));
    }

    function showQuestion(question) {
      let questionDisplay = document.getElementById('questionDisplay');
      if (!questionDisplay) {
        questionDisplay = document.createElement('div');
        questionDisplay.id = 'questionDisplay';
        questionDisplay.classList.add('question-display');
        questionDisplay.innerHTML = '<h3>Question:</h3><p></p>';
        document.body.appendChild(questionDisplay);
      }
      questionDisplay.querySelector('p').textContent = question;
      questionDisplay.style.opacity = '1';
    }

    function hideQuestion() {
      const questionDisplay = document.getElementById('questionDisplay');
      if (questionDisplay) {
        questionDisplay.style.opacity = '0';
      }
    }

    function highlightCombinations(questionID) {
      const gridSize = 4;
      const row = Math.floor((questionID - 1) / gridSize);
      const col = (questionID - 1) % gridSize;

      removeHighlight();

      // Highlight row
      for (let i = 0; i < gridSize; i++) {
        document.querySelectorAll('#questionGrid .grid-item')[row * gridSize + i].classList.add('highlight');
      }

      // Highlight column
      for (let i = 0; i < gridSize; i++) {
        document.querySelectorAll('#questionGrid .grid-item')[i * gridSize + col].classList.add('highlight');
      }

      // Highlight diagonal (if applicable)
      if (row === col) {
        for (let i = 0; i < gridSize; i++) {
          document.querySelectorAll('#questionGrid .grid-item')[i * gridSize + i].classList.add('highlight');
        }
      }
      if (row + col === gridSize - 1) {
        for (let i = 0; i < gridSize; i++) {
          document.querySelectorAll('#questionGrid .grid-item')[(gridSize - 1 - i) * gridSize + i].classList.add('highlight');
        }
      }
    }

    function removeHighlight() {
      document.querySelectorAll('#questionGrid .grid-item').forEach(item => {
        item.classList.remove('highlight');
      });
    }

    function showOptions(questionID) {
      const gridSize = 4;
      const row = Math.floor((questionID - 1) / gridSize);
      const col = (questionID - 1) % gridSize;

      const options = [];

      // Row option
      options.push(Array.from({length: gridSize}, (_, i) => row * gridSize + i + 1));

      // Column option
      options.push(Array.from({length: gridSize}, (_, i) => i * gridSize + col + 1));

      // Diagonal options (if applicable)
      if (row === col) {
        options.push(Array.from({length: gridSize}, (_, i) => i * gridSize + i + 1));
      }
      if (row + col === gridSize - 1) {
        options.push(Array.from({length: gridSize}, (_, i) => (gridSize - 1 - i) * gridSize + i + 1));
      }

      const optionsHtml = options.map((option, index) =>
        `<div class="mb-2">
           <input type="radio" id="option${index}" name="combination" value='${JSON.stringify(option)}'>
           <label for="option${index}">${option.join(', ')}</label>
         </div>`
      ).join('');

      Swal.fire({
        title: 'Select a combination',
        html: `<form id="combinationForm">${optionsHtml}</form>`,
        showCancelButton: true,
        confirmButtonText: 'Submit',
        preConfirm: () => {
          const selectedOption = document.querySelector('input[name="combination"]:checked');
          if (!selectedOption) {
            Swal.showValidationMessage('Please select a combination');
            return false;
          }
          return JSON.parse(selectedOption.value);
        }
      }).then((result) => {
        if (result.isConfirmed) {
          submitCombination(result.value);
        }
      });
    }

     function submitCombination(selectedOption) {
    // Show loading spinner
    Swal.fire({
      title: 'Submitting...',
      html: '<div class="spinner mx-auto"></div>',
      showConfirmButton: false,
      allowOutsideClick: false
    });

    // Join the selectedOption array into a single string
    const questionIDs = selectedOption.join(',');

    google.script.run.withSuccessHandler(function(result) {
      Swal.close(); // Close the loading spinner

      if (result.success) {
        Swal.fire({
          icon: 'success',
          title: 'Combination Submitted',
          text: result.message,
          confirmButtonText: 'OK',
        }).then((result) => {
          if (result.isConfirmed) {
            logout();
          }
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Submission Failed',
          text: result.message || 'An error occurred while submitting the combination.',
        });
      }
    }).updateAttemptedQuestion(localStorage.getItem('teamID'), questionIDs, localStorage.getItem('email'));
  }

    function logout() {
      google.script.run.withSuccessHandler(function(response) {
        if (response.success) {
          localStorage.clear();
          document.getElementById('loginForm').style.display = 'block';
          document.getElementById('dashboard').style.display = 'none';
          document.getElementById('teamID').value = '';
          document.getElementById('contactNumber').value = '';
        }
      }).doLogout();
    }
  </script>
</head>
<body class="bg-gray-100">
  <!-- Login Form -->
  <div id="loginForm" class="p-8 bg-white dark:bg-black rounded shadow-md w-96 mx-auto mt-20">
    <h2 class="text-2xl dark:text-white font-bold mb-6 text-center">Team Login</h2>
    <input id="teamID" type="text" placeholder="Team ID" class="border p-2 mb-4 w-full">
    <input id="contactNumber" type="password" placeholder="Password" class="border p-2 mb-4 w-full">
    <button id="loginButton" onclick="login()" class="bg-blue-500 text-white p-2 rounded w-full hover:bg-blue-700">Login</button>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden">
    <div class="p-8 bg-white dark:bg-black rounded shadow-md w-96 mx-auto mt-20">
      <h2 class="dark:text-white text-2xl font-bold mb-4 text-center">Welcome, <span id="teamNameDisplay"></span>!</h2>
      <p class="dark:text-white mb-2"><strong>Team ID:</strong> <span id="teamIDDisplay"></span></p>
      <p class="dark:text-white mb-4"><strong>Team Leader:</strong> <span id="teamLeaderDisplay"></span></p>

      <div id="countdownTimer" class="dark:text-white text-center font-bold mb-6"></div>

      <button onclick="logout()" class="bg-red-500 text-white p-2 rounded w-full hover:bg-red-700 mb-6">Logout</button>
      
      <div id="questionGrid" class="grid grid-cols-4 gap-4"></div>
    </div>
  </div>
</body>
</html>
